---
title: 跨域问题解决方案
tag:
-  CORS
-  Cookie
-  跨域
categories:
- 工作
---

在客户端会使用XMLHttpRequest 对象向后端应用发起请求，出于安全考虑，浏览器会限制脚本中发起的跨站请求。

前端项目域名： h5.51ping.com   后端项目域名： e.51ping.com

目前线上的解决方案是  通过跨域资源共享 CORS在请求头中自定义一个Header字段userInfo,后端应用从Header中获取userInfo.   

但是放在cookie中，后端始终不能获取到。


这里主要是解决后端应用不能从cookie中获取userInfo的问题
<!-- more -->

## 方案－跨域资源共享 CORS
### 第一步：预检请求时，服务端在请求头中添加字段
 
（1）Access-Control-Allow-Origin
 
该字段是必须的。它的值要么是请求时Origin字段的值，要么是一个*，表示接受任意域名的请求。
 
（2）Access-Control-Allow-Credentials
该字段可选。它的值是一个布尔值，表示是否允许发送Cookie。

	@Override
	public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
	    HttpServletResponse resp = (HttpServletResponse)response;
	    resp.setHeader("Access-Control-Allow-Origin", LionConfigUtils.getProperty("http://h5.51ping.com"));
	    resp.setHeader("Access-Control-Allow-Credentials", "true");
	//  resp.setHeader("Access-Control-Allow-Headers", "userInfo");   //在实际的请求中,可以使用的自定义HTTP请求头
	
	    HttpServletRequest req = (HttpServletRequest) request;
	    if (req.getMethod().equals("OPTIONS")) {
	        resp.setStatus(200);
	        resp.flushBuffer();
	    } else {
	        chain.doFilter(request,response);
	    }
	}
### 第二步：客户端需要在XMLHttpRequest 请求中设置withCredentials属性为true
	var xhr = new XMLHttpRequest();
	xhr.withCredentials = true;
### 第三步：设置document.cookie
在XMLHttpRequest 请求发出之前设置 document.cookie="userInfo=xxx"

## 问题
### 问题1  
 服务端拿不到cookie,  客户端没有发送cookie
 
 
 **解决方法**
 
 依赖的模块设置了这个条件 credentials: "include" ＝> xhr.withCredentials = true  客户端发送cookie
 
### 问题2
客户端发送了cookie，但服务端只能拿到两个字段，userInfo和catBrowserName拿不到
![](/images/QQ20161017-0@2x.png)
![](/images/QQ20161017-1@2x.png)

 
如果第三步不做 userInfo和catBrowserName都没有
![](/images/QQ20161017-2@2x.png)

说明这是cookie可访问域有限制。
 
***解决方法***

跨域请求时，如果要发送cookie,有两点需要注意：

- Access-Control-Allow-Origin不能设为星号，必须指定明确的、与请求网页一致的域名。
- Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，并且网页代码中的document.cookie也无法读取服务器域名下的Cookie。

在客户端设置cookie时，需要指定服务器端可访问cookie的路径,  设置cookie.domain 与服务器域名一致（.51ping.com）和 cookie.path 为根路径
 
![](/images/QQ20161017-3@2x.png)
![](/images/QQ20161017-4@2x.png)

## 参考文章
 
- [HTTP访问控制(CORS)](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS#Access-Control-Allow-Headers) 
- [跨域资源共享 CORS 详解](http://www.ruanyifeng.com/blog/2016/04/cors.html) 
- [Document.cookie](https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie)